<!--
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Manager Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        var stompClient = null;

        function connect() {
            var socket = new SockJS('/websocket');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/notifications', function (notification) {
                    showNotification(JSON.parse(notification.body));
                });
            });
        }

        function showNotification(notification) {
			console.log(notification);
            var notifications = document.getElementById('notifications');
            var notificationElement = document.createElement('div');
            notificationElement.appendChild(document.createTextNode(notification.message));
			var notificationElement1 = document.createElement('div');
			notificationElement1.appendChild(document.createTextNode(notification.orderId));
            notifications.appendChild(notificationElement1);
        }

        window.onload = function() {
            connect();
        };
    </script>
</head>
<body>
    <h1>Manager Dashboard</h1>
    <div id="notifications">
        <h2>Notifications</h2>
    </div>
</body>
</html>-->

<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Manager Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">Manager Dashboard</h1>
    <p class="text-center">Real-time notifications of received orders.</p>

    <!-- Notification List -->
    <div class="mt-4">
        <h3>New Orders</h3>
        <ul id="notificationList" class="list-group">
            <!-- Notifications will appear here dynamically -->
        </ul>
    </div>

    <!-- Order Details -->
    <div id="orderDetails" class="mt-4" style="display: none;">
        <h3>Order Details</h3>
        <div id="orderContent" class="border p-3">
            <!-- Order details will be displayed here -->
        </div>
    </div>
</div>

<script>
    let stompClient = null;

    // Function to connect to WebSocket
    function connect() {
        const socket = new SockJS('/websocket'); // WebSocket endpoint
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/notifications', function (notification) {
                displayNotification(JSON.parse(notification.body));
            });
        });
    }

    // Function to display notification
    function displayNotification(notification) {
        if (!notification.read) {
            const notificationList = document.getElementById("notificationList");
            const li = document.createElement("li");
            li.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");
            li.innerHTML = `
                <span>${notification.message}</span>
                <div>
                    <button onclick="viewOrder(${notification.orderId})" class="btn btn-primary btn-sm">View Order</button>
                    <button onclick="markAsRead(${notification.id})" class="btn btn-secondary btn-sm">Mark as Read</button>
                </div>
            `;
            notificationList.appendChild(li);
        }
    }

    // Function to view order details
    function viewOrder(orderId) {
        fetch('/manager/orders/' + orderId)
            .then(response => response.json())
            .then(order => {
                const orderDetails = document.getElementById("orderDetails");
                const orderContent = document.getElementById("orderContent");
                orderContent.innerHTML = `
                    <p><strong>Order ID:</strong> ${order.orderId}</p>
                    <p><strong>Customer Name:</strong> ${order.orderDate}</p>
                    <p><strong>Order Date:</strong> ${order.totalAmount}</p>
                   
                `;
                orderDetails.style.display = 'block';
            });
    }

    // Function to mark notification as read
    function markAsRead(notificationId) {
        // Send a request to the server to mark the notification as read
        fetch('/notifications/markAsRead/' + notificationId, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                // Remove the notification from the list
                const notificationList = document.getElementById("notificationList");
                const items = notificationList.getElementsByTagName("li");
                for (let i = 0; i < items.length; i++) {
                    if (items[i].innerHTML.includes(notificationId)) {
                        notificationList.removeChild(items[i]);
                        break;
                    }
                }
            }
        });
    }

    // Connect to WebSocket on page load
    document.addEventListener("DOMContentLoaded", connect);
</script>
</body>
</html>